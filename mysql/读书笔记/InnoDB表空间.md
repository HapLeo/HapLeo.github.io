# InnoDB表空间

表空间就是用来存储表记录的磁盘空间，体现在文件系统上就是一个或多个文件。

表空间分为系统表空间（system tablespace）和独立表空间（file-per-table tablespace），系统表空间有一个或多个文件，默认为数据目录下名为ibdata1的文件,独立表空间是文件名与表名相同，后缀为.ibd的文件，每个表一个文件。

InnoDB以页为单位管理存储空间，页有很多种，包括索引页、BLOB页、undo日志页等。每一种页都有它自己的结构，但所有页都有File Header和File Trailer两个部分。File Header保存了页的校验和、页号、上一页号、下一页号、页面类型、所属表空间等。File Trailer则保存了页的校验和等信息。

## 区 （extent）

区是管理页的逻辑单位，每个区管理连续64个页，即1MB空间。当数据量大时，为了尽量顺序I/O以提高读写性能，InnoDB会以整个区（1MB）为单位分配连续存储空间。连续256个区有组成一个组。我们知道，页有很多种类型，用每一页File Header中的FIL_PAGE_TYPE属性区分，例如索引页INDEX,溢出页BLOB等。每个表空间用它的第一个页来保存这个表空间的概况，这个页的类型为FSP_HDR。其他每个区的第一个页类型为XDES（即：extent descriptor），用来描述这个区的概况。

B+树中有叶子节点和非叶子结点，每个节点表现为一个页。对于每一个B+树，它的所有叶子节点被标记为一个段（segment），所有的非叶子结点被标记为另一个段，一个B+树就有两个段。

为了减少随机I/O，InnoDB会整个整个区来分配空间，这对于大表来说优化了查询效率，但是对于小表来说，造成了空间的浪费。因此，在表空间中单独开辟了一块碎片区（fragment），如果索引中记录很小，会先占用碎片区中的页，当它占用了32个碎片区之后，就会以完整的区为单位为这个索引分配空间。因为碎片区可以被多个索引使用，也可以被标记成其他类型的页，因此提高了空间利用率。

## 段（segment）

什么是段？为什么要有段的概念？段是用来将索引的叶子节点和非叶子结点进行逻辑分区的概念，本质是将区进行标记。每个区都有一个40个字节的XDES Entry结构，可以保存段的ID，区的状态（FREE/FREE_FRAG/FULL_FRAG/FSEG），前一个XDES Entry的指针，后一个XDES Entry的指针。状态为FSEG的区归属于某个段，通过前后指针连成双向链表。为什么要将同一个段的区连成双向链表？这样可以加快针对索引列的范围查询的速度。

