# innoDB中事务回滚机制实现原理简述

相关标签：事务原子性

[TOC]

## 一些概念

**事务**：英文`transaction(交易)`，一笔交易由多个步骤组成，这些步骤要么全部做完，要么一个不做。

**事务id**：内存中的一个全局变量，开启一个事务后，在执行第一个 <u>增删改操作</u> 时为这个事务分配一个全局唯一的id；

**只读事务**：通过`start transaction read only`开启，只能查询，增删改操作会报错，不分配事务id；

**读写事务**：通过`begin`或`start transaction` 或`start transaction read write` 开启；

> 事务通过`rollback`回滚结束 或`commit`提交结束； 

## 一些问题

- 为什么需要事务回滚机制？

一个复杂的任务，需要分步完成，当某个步骤不满足条件而不希望执行下去时，需要回滚机制。

一个复杂的任务，服务器需要分步完成，当执行某个步骤时突然断电、宕机，任务无法继续，需要回滚机制。

- 如何实现事务回滚机制？

  将一个事务对数据改动的每一个步骤都记录成日志，需要回滚时，按照日志再改回去。

  - 新增记录：回滚时删除这条记录；
  - 修改记录：先记下原来的记录值，再修改，回滚时将原来的值改回来。
  - 删除记录：先标记删除，回滚时将标记改回来。

- innoDB中是如何记录事务回滚日志的？

  **undo log** 是innoDB中的事务回滚日志，它保存在类型为`FIL_PAGE_UNDO_LOG`的页中。