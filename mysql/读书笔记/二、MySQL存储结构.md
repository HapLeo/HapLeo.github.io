# Mysql的存储结构

## 行

行格式是用于存储一条记录的格式，在innoDB中有四种行格式，分别为：**Redundant**,**Compact**,**Dynamic**和**Compressed**.

一条行记录保存在硬盘上，不仅仅保存了用户的数据，还要保存额外信息，比如每个字段的长度列表、NULL值列表、记录头信息、隐藏列。

**隐藏列**包括row_id,transaction_id和roll_pointer三个字段。innoDB会为每条记录保存transaction_id和roll_pointer字段以支持事务。另外，如果一个表没有指定主键，innoDB会寻找一个唯一列作为主键，如果没有唯一列，则会自动生成row_id作为主键，此时就会在记录行中保存row_id字段。

**Redundant**（冗余的）: 它将所有列（包括隐藏列）的长度信息保存在字段长度列表中。长度信息中第一个比特位如果为1表示该字段值为NULL。

**Compact**（紧凑的）: 它只保存变长字段的长度信息，单独保存NULL值列表， 因此长度列表信息会节省一部分存储空间，信息紧凑。

**Dynamic**(动态的)：当前innoDB默认行格式，它与Compact类似，区别在于对**字段溢出**的处理不同。nvarchar、text、blob等类型字段，在保存大量数据时，由于每个数据页是固定大小16KB，会导致当前数据页无法存下，此时Compact行格式仍会保存部分数据在当前字段中，而Dynamic行格式则会直接将该字段值保存到其他数据页中，当前字段中只保存指向溢出数据页的指针。

**Compressed**（压缩的）: 与Dynamic行格式类似，区别是它会采用压缩算法对页面进行压缩。



## 页

InnoDB中有很多类型的页，用于存储不同类型的数据。例如：

|        类型名称         |     描述     |
| :---------------------: | :----------: |
|   `FIL_PAGE_UNDO_LOG`   |  Undo日志页  |
|   `FIL_PAGE_TYPE_SYS`   |    系统页    |
| `FIL_PAGE_TYPE_TRX_SYS` | 事务系统数据 |
|  `FIL_PAGE_TYPE_BLOB`   |    溢出页    |
|    `FIL_PAGE_INDEX`     |    索引页    |



innoDB中用于存储表记录的页叫做**索引页**；每一页的大小为16KB，为固定值。

索引页的结构如下：

|         名称         |       中文名       | 占用空间大小 |              简单描述              |
| :------------------: | :----------------: | :----------: | :--------------------------------: |
|    `File Header`     |      文件头部      |   `38`字节   | 所有类型页通用头部，保存前后页指针 |
|    `Page Header`     |      页面头部      |   `56`字节   |     索引页专用头部，记录页信息     |
| `Infimum + Supremum` | 最小记录和最大记录 |   `26`字节   |        innoDB自动生成的记录        |
|    `User Records`    |      用户记录      |    不确定    |         用户插入的数据记录         |
|     `Free Space`     |      空闲空间      |    不确定    |              空闲空间              |
|   `Page Directory`   |      页面目录      |    不确定    |       用于页内二分法查找记录       |
|    `File Trailer`    |      文件尾部      |   `8`字节    |       保存日志序列号与校验和       |

每插入一条记录，都会从Free Space区域划分一块空间到User Records,用于存储此条记录。

Page Directory 用于在页内检索一条记录。在每一页中，所有的记录（包括infimum和supremum）会被划分为多个组，每个组中主键最大的记录的位置会被记录到Page Directory中作为目录，由于User Records中的记录是按照主键排序，切组内记录通过next_record字段形成单链表，因此只需要用二分法通过Page Directory查找到记录所在的组，再遍历单链表，即可检索到目标记录。

数据从日志同步到索引页的过程：

- 修改 File Header中的校验和
- 从日志中读取并写入索引页
- 在File Trailer中记录日志序列号LSN，并修改校验和，使得与File Header中校验和一致，如不一致，说明同步出错。